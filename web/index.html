<!-- FILE: web/index.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Calibrate MVP</title>
  <style>
    :root{
      --bg:#f7f8fc;
      --card:#ffffff;
      --ink:#0f172a;
      --muted:#64748b;
      --line:rgba(15,23,42,.10);
      --shadow:0 10px 35px rgba(2,6,23,.08);
      --blue:#2563eb;
      --blue2:#1d4ed8;
      --green:#16a34a;
      --red:#dc2626;
      --amber:#d97706;
      --radius:16px;
      --radius2:22px;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--ink);
      background:
        radial-gradient(1200px 800px at 10% -10%, rgba(37,99,235,.10), transparent 60%),
        radial-gradient(900px 700px at 90% 0%, rgba(22,163,74,.07), transparent 55%),
        radial-gradient(1000px 800px at 30% 120%, rgba(217,119,6,.06), transparent 60%),
        var(--bg);
    }

    .wrap{ max-width:1100px; margin:0 auto; padding:22px 18px 44px; }
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:14px; margin-bottom:14px;
    }
    .brand{
      display:flex; align-items:center; gap:10px; user-select:none;
    }
    .logo{
      width:38px; height:38px; border-radius:12px;
      background:linear-gradient(135deg, rgba(37,99,235,1), rgba(29,78,216,.85));
      box-shadow:0 10px 22px rgba(37,99,235,.25);
      position:relative;
    }
    .logo::after{
      content:"";
      position:absolute; inset:10px 9px 11px 9px;
      border-radius:10px;
      background:rgba(255,255,255,.92);
      clip-path: polygon(14% 60%, 14% 40%, 52% 40%, 52% 25%, 86% 50%, 52% 75%, 52% 60%);
      opacity:.95;
    }
    .brandTitle{ font-weight:900; letter-spacing:.2px; }
    .brandSub{ color:var(--muted); font-size:12.5px; margin-top:2px; }
    .brandText{ display:flex; flex-direction:column; line-height:1.05; }
    .nav{
      display:flex; align-items:center; gap:8px; flex-wrap:wrap;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 11px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.85);
      box-shadow:0 8px 20px rgba(2,6,23,.05);
      font-size:13px;
      cursor:pointer;
      transition:.15s transform, .15s background, .15s border;
      text-decoration:none;
      color:inherit;
      position:relative;
    }
    .pill:hover{ transform: translateY(-1px); background:#fff; border-color:rgba(15,23,42,.18); }
    .pill.active{ border-color:rgba(37,99,235,.45); box-shadow:0 10px 26px rgba(37,99,235,.12); }
    .pillDot{
      width:9px; height:9px; border-radius:99px;
      background:rgba(37,99,235,.85);
      box-shadow:0 0 0 4px rgba(37,99,235,.12);
    }

    .card{
      background:rgba(255,255,255,.9);
      border:1px solid var(--line);
      border-radius:var(--radius2);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .cardInner{ padding:18px; }

    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:14px;
    }
    @media (max-width: 960px){
      .grid{ grid-template-columns:1fr; }
    }

    .h1{ font-size:18px; font-weight:950; letter-spacing:.2px; margin:0 0 6px; }
    .muted{ color:var(--muted); font-size:13.5px; line-height:1.35; }

    label{ display:block; font-size:13px; color:var(--muted); margin:12px 0 6px; }
    .field, select, textarea{
      width:100%;
      border:1px solid var(--line);
      background:rgba(255,255,255,.9);
      border-radius:14px;
      padding:10px 12px;
      font-size:14px;
      outline:none;
      transition:.15s border, .15s box-shadow, .15s background;
      font-family:var(--sans);
    }
    textarea{ min-height:108px; resize:vertical; }
    .field:focus, select:focus, textarea:focus{
      border-color:rgba(37,99,235,.55);
      box-shadow:0 0 0 4px rgba(37,99,235,.12);
      background:#fff;
    }
    .row{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    .btn{
      border:0;
      border-radius:14px;
      padding:10px 14px;
      font-weight:800;
      cursor:pointer;
      background:linear-gradient(135deg, rgba(37,99,235,1), rgba(29,78,216,1));
      color:white;
      box-shadow:0 12px 26px rgba(37,99,235,.22);
      transition:.15s transform, .15s filter;
      display:inline-flex; align-items:center; gap:10px;
    }
    .btn:hover{ transform: translateY(-1px); filter:saturate(1.05); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; transform:none; }
    .btn.secondary{
      background:rgba(255,255,255,.9);
      color:var(--ink);
      border:1px solid var(--line);
      box-shadow:0 10px 22px rgba(2,6,23,.06);
    }
    .btn.secondary:hover{ background:#fff; }
    .btn.danger{
      background:linear-gradient(135deg, rgba(220,38,38,1), rgba(185,28,28,1));
      box-shadow:0 12px 26px rgba(220,38,38,.18);
    }

    .hint{
      font-size:12.5px;
      color:var(--muted);
      margin-top:8px;
    }

    .divider{
      height:1px;
      background:linear-gradient(90deg, transparent, rgba(15,23,42,.10), transparent);
      margin:16px 0;
    }

    .toast{
      position:fixed;
      right:18px; bottom:18px;
      max-width:340px;
      background:rgba(255,255,255,.95);
      border:1px solid var(--line);
      border-radius:16px;
      box-shadow:0 20px 50px rgba(2,6,23,.18);
      padding:12px 14px;
      font-size:13.5px;
      display:none;
      z-index:999;
    }
    .toast.show{ display:block; animation:pop .16s ease-out; }
    @keyframes pop{ from{ transform:translateY(8px); opacity:.0;} to{ transform:translateY(0); opacity:1;} }

    .tag{
      display:inline-flex; align-items:center;
      border-radius:999px;
      padding:5px 10px;
      font-size:12px;
      font-weight:900;
      letter-spacing:.06em;
      text-transform:uppercase;
      border:1px solid var(--line);
      background:rgba(255,255,255,.85);
    }
    .tag.ok{ color:var(--green); border-color:rgba(22,163,74,.28); background:rgba(22,163,74,.08); }
    .tag.bad{ color:var(--red); border-color:rgba(220,38,38,.28); background:rgba(220,38,38,.08); }
    .tag.warn{ color:var(--amber); border-color:rgba(217,119,6,.28); background:rgba(217,119,6,.08); }

    .mono{ font-family:var(--mono); font-size:12.5px; }
    .small{ font-size:12.5px; color:var(--muted); }

    .sectionTitle{
      margin:0 0 10px;
      font-size:13px;
      letter-spacing:.13em;
      text-transform:uppercase;
      color:var(--muted);
      font-weight:950;
    }

    .kv{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 560px){
      .kv{ grid-template-columns:1fr; }
    }
    .kvItem{
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px 12px;
      background:rgba(255,255,255,.92);
      display:flex; flex-direction:column; gap:6px;
      min-height:60px;
    }
    .kvK{ font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:.12em; font-weight:900; }
    .kvV{ font-weight:900; }
    .kvV.sub{ font-weight:700; color:var(--muted); font-size:13.5px; line-height:1.35; }

    /* Transcript blocks */
    .transcript{
      display:flex; flex-direction:column; gap:10px;
    }
    .tLine{
      display:flex; gap:10px; align-items:flex-start;
    }
    .tChip{
      flex:0 0 auto;
      padding:7px 10px;
      border-radius:999px;
      font-weight:900;
      font-size:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.90);
    }
    .tChip.you{ background:rgba(37,99,235,.10); border-color:rgba(37,99,235,.22); color:var(--blue2); }
    .tChip.pro{ background:rgba(22,163,74,.10); border-color:rgba(22,163,74,.22); color:var(--green); }
    .tText{
      border:1px solid var(--line);
      border-radius:16px;
      padding:10px 12px;
      background:rgba(255,255,255,.92);
      width:100%;
      line-height:1.35;
      font-size:14px;
    }

    /* Report */
    details{
      border:1px solid var(--line);
      background:rgba(255,255,255,.92);
      border-radius:16px;
      padding:0;
      overflow:hidden;
    }
    summary{
      cursor:pointer;
      padding:12px 12px;
      font-weight:950;
      list-style:none;
      display:flex; align-items:center; justify-content:space-between;
      user-select:none;
    }
    summary::-webkit-details-marker{ display:none; }
    .reportBody{
      padding:0 12px 12px;
      color:var(--ink);
      font-size:14px;
      line-height:1.45;
    }
    .reportBody p{ margin:10px 0; }
    .reportBody ul{ margin:10px 0 10px 18px; padding:0; }
    .reportBody li{ margin:6px 0; }
    .reportBody .mutedLine{ color:var(--muted); font-size:13.5px; }

    .badge{
      font-size:12px;
      color:var(--muted);
      border:1px solid var(--line);
      border-radius:999px;
      padding:5px 9px;
      background:rgba(255,255,255,.86);
    }

    /* History list */
    .list{
      display:flex; flex-direction:column; gap:10px;
    }
    .listItem{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      border:1px solid var(--line);
      border-radius:18px;
      padding:12px 12px;
      background:rgba(255,255,255,.92);
      cursor:pointer;
      transition:.15s transform, .15s border, .15s background;
    }
    .listItem:hover{ transform:translateY(-1px); border-color:rgba(15,23,42,.18); background:#fff; }
    .liLeft{ display:flex; flex-direction:column; gap:4px; min-width:0; }
    .liTitle{ font-weight:950; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:620px; }
    .liMeta{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; color:var(--muted); font-size:12.5px; }
    .liRight{ display:flex; align-items:center; gap:10px; flex:0 0 auto; }
    .chev{ color:var(--muted); font-weight:900; }

    /* Outcome pill */
    .outcomePill{
      display:inline-flex; align-items:center;
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      font-weight:950;
      text-transform:uppercase;
      letter-spacing:.08em;
      border:1px solid var(--line);
      background:rgba(255,255,255,.86);
      white-space:nowrap;
    }
    .outcomePill.win{ color:var(--green); border-color:rgba(22,163,74,.30); background:rgba(22,163,74,.10); }
    .outcomePill.loss{ color:var(--red); border-color:rgba(220,38,38,.30); background:rgba(220,38,38,.10); }
    .outcomePill.followup{ color:var(--amber); border-color:rgba(217,119,6,.30); background:rgba(217,119,6,.10); }
    .outcomePill.unknown{ color:var(--muted); }

    /* Tooltip */
    .hasTip{ position:relative; }
    .hasTip:hover::after{
      content: attr(data-tip);
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      bottom: calc(100% + 10px);
      background: rgba(15,23,42,.92);
      color: #fff;
      padding: 8px 10px;
      border-radius: 12px;
      font-size: 12.5px;
      line-height:1.25;
      white-space: nowrap;
      box-shadow: 0 16px 40px rgba(2,6,23,.26);
      z-index: 50;
    }
    .hasTip:hover::before{
      content:\" \";
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      bottom: calc(100% + 3px);
      width: 0; height: 0;
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-top: 8px solid rgba(15,23,42,.92);
      z-index: 50;
    }

    /* NEW: top 3-panel row for Run view */
    .triGrid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:12px;
      margin-top:10px;
    }
    @media (max-width: 960px){
      .triGrid{ grid-template-columns:1fr; }
    }
    .panel{
      border:1px solid var(--line);
      background:rgba(255,255,255,.92);
      border-radius:18px;
      padding:12px;
      min-height:190px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .panel.center{ text-align:center; }
    .panel.center .panelBody{ align-items:center; text-align:center; }
    .panelHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .panelTitle{
      margin:0;
      font-size:12px;
      letter-spacing:.13em;
      text-transform:uppercase;
      color:var(--muted);
      font-weight:950;
    }
    .panelBody{
      flex:1;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .outcomeBig{
      font-size:24px;
      font-weight:950;
      letter-spacing:.2px;
      margin-top:4px;
    }
    .outcomeReason{
      color:var(--muted);
      font-size:13.5px;
      line-height:1.35;
    }
    .metaRow{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      justify-content:center;
      margin-top:auto;
    }
    .fixList{ display:grid; gap:8px; }
    .fixItem{
      display:flex;
      gap:10px;
      align-items:flex-start;
      padding:10px;
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(15,23,42,0.02);
      text-align:left;
    }
    .fixNum{
      width:22px; height:22px;
      border-radius:999px;
      display:grid; place-items:center;
      font-weight:950;
      font-size:12px;
      background:rgba(37,99,235,.10);
      border:1px solid rgba(37,99,235,.18);
      color:var(--blue2);
      flex:0 0 auto;
      margin-top:1px;
    }
    .fixText{ font-size:13.5px; line-height:1.35; }
    .panelBtns{ display:flex; gap:8px; align-items:center; justify-content:flex-end; }
    .btn.small{
      padding:8px 10px;
      border-radius:14px;
      font-weight:900;
      font-size:13px;
      gap:8px;
    }
    .pbSmall{ font-size:12.5px; color:var(--muted); line-height:1.35; }

    /* Playbook */
    .pbLayout{
      display:grid;
      grid-template-columns: 0.92fr 1.08fr;
      gap:14px;
    }
    @media (max-width: 980px){
      .pbLayout{ grid-template-columns:1fr; }
    }
    .pbList{
      display:flex; flex-direction:column; gap:10px;
    }
    .pbItem{
      border:1px solid var(--line);
      background:rgba(255,255,255,.92);
      border-radius:18px;
      padding:12px 12px;
      cursor:pointer;
      transition:.15s transform, .15s border, .15s background;
    }
    .pbItem:hover{ transform:translateY(-1px); border-color:rgba(15,23,42,.18); background:#fff; }
    .pbItem.active{ border-color:rgba(37,99,235,.45); box-shadow:0 12px 28px rgba(37,99,235,.12); }
    .pbTop{ display:flex; align-items:flex-start; justify-content:space-between; gap:10px; }
    .pbTitle{ font-weight:950; margin:0; }
    .pbMeta{ color:var(--muted); font-size:12.5px; margin-top:4px; }
    .pbEditor{
      border:1px solid var(--line);
      background:rgba(255,255,255,.92);
      border-radius:18px;
      padding:12px;
    }
    .pbEditor .row{ justify-content:space-between; }
    .pbEditor textarea{
      min-height:220px;
      font-family:var(--sans);
      font-size:14px;
      line-height:1.4;
    }
    .pbVersions{
      margin-top:10px;
      display:flex; flex-direction:column; gap:8px;
    }
    .pbVer{
      border:1px solid var(--line);
      border-radius:16px;
      padding:10px 10px;
      background:rgba(255,255,255,.92);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .pbVerLeft{ display:flex; flex-direction:column; gap:2px; }
    .pbVerTitle{ font-weight:950; font-size:13px; }
    .pbVerMeta{ font-size:12.5px; color:var(--muted); }
    .pbVerBtn{ padding:8px 10px; border-radius:14px; }

    /* Banner */
    .banner{
      border:1px solid var(--line);
      border-radius:18px;
      padding:12px 12px;
      background:rgba(255,255,255,.92);
      display:flex;
      gap:10px;
      align-items:flex-start;
      margin-top:10px;
    }
    .bannerIcon{
      width:32px; height:32px;
      border-radius:12px;
      display:grid; place-items:center;
      font-weight:950;
      color:#fff;
      flex:0 0 auto;
    }
    .bannerIcon.warn{ background:rgba(217,119,6,1); }
    .bannerIcon.bad{ background:rgba(220,38,38,1); }
    .bannerIcon.ok{ background:rgba(22,163,74,1); }
    .bannerText{ display:flex; flex-direction:column; gap:3px; }
    .bannerTitle{ font-weight:950; }
    .bannerDesc{ color:var(--muted); font-size:13.5px; line-height:1.35; }

  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand" onclick="goto('/')">
        <div class="logo" aria-hidden="true"></div>
        <div class="brandText">
          <div class="brandTitle">Calibrate MVP</div>
          <div class="brandSub">Upload an audio file + pick a scenario. You’ll get transcript + coaching report.</div>
        </div>
      </div>

      <div class="nav">
        <a class="pill" id="navHome" onclick="goto('/')"><span class="pillDot"></span>Home</a>
        <a class="pill" id="navPlaybook" onclick="goto('/playbook')"><span class="pillDot" style="background:rgba(22,163,74,.85); box-shadow:0 0 0 4px rgba(22,163,74,.12)"></span>Playbook</a>
      </div>
    </div>

    <div id="viewRoot"></div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // --------- tiny router ----------
    const routes = {};
    const viewRoot = document.getElementById('viewRoot');
    const navHome = document.getElementById('navHome');
    const navPlaybook = document.getElementById('navPlaybook');

    function setActiveNav(path){
      navHome.classList.toggle('active', path === '/' || path.startsWith('/run'));
      navPlaybook.classList.toggle('active', path.startsWith('/playbook'));
    }

    function goto(path){
      history.pushState({}, '', path);
      renderRoute();
    }
    window.addEventListener('popstate', renderRoute);

    function toast(msg){
      const el = document.getElementById('toast');
      el.textContent = msg;
      el.classList.add('show');
      setTimeout(()=> el.classList.remove('show'), 2200);
    }

    // --------- api helpers ----------
    async function apiGet(url){
      const r = await fetch(url);
      if(!r.ok) throw new Error(await r.text());
      return r.json();
    }
    async function apiPost(url, body){
      const r = await fetch(url, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(body || {})
      });
      if(!r.ok) throw new Error(await r.text());
      return r.json();
    }
    async function apiUpload(url, formData){
      const r = await fetch(url, { method:'POST', body: formData });
      if(!r.ok) throw new Error(await r.text());
      return r.json();
    }

    // --------- utilities ----------
    function fmtDate(iso){
      try{
        const d = new Date(iso);
        if(isNaN(+d)) return '';
        return d.toLocaleString([], { year:'numeric', month:'short', day:'2-digit', hour:'2-digit', minute:'2-digit' });
      }catch{ return ''; }
    }
    function escapeHtml(s){
      return (s||'').replace(/[&<>"']/g, c => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'
      }[c]));
    }

    // --------- scenario templates ----------
    const scenarioTemplates = {
      none: { label: 'None', helper: 'No scenario framing applied.' },
      b2b:  { label: 'B2B service / software', helper: 'Use ROI/time-saved/pipeline language. Qualify decision-maker, current tool/process, measurable outcome, and a low-friction next step (10-min walkthrough).' },
      retail:{ label: 'Local service / retail', helper: 'Focus on convenience, availability, and simple next steps. Confirm fit, budget sensitivity, and booking flow.' },
      recruiting:{ label: 'Recruiting / staffing', helper: 'Clarify role urgency, hiring process, and decision chain. Offer a fast shortlist and specific next-step meeting.' }
    };

    const legacyScenarioMap = {
      none: 'None',
      seo: 'SEO agency pitch',
      maintenance: 'Website maintenance',
      ai_receptionist: 'AI receptionist'
    };

    // --------- Call outcome mapping ----------
    function normalizeOutcomeKey(s){
      const t = (s||'').toLowerCase();
      if(t.includes('pass')) return 'pass';
      if(t.includes('booked')) return 'booked';
      if(t.includes('meeting')) return 'booked';
      if(t.includes('follow')) return 'followup';
      if(t.includes('no_show')) return 'no_show';
      if(t.includes('objection')) return 'objection';
      if(t.includes('fail')) return 'fail';
      return t || 'unknown';
    }
    function outcomeLabel(key){
      if(key==='booked') return 'BOOKED ✅';
      if(key==='pass') return 'PASS ✅';
      if(key==='followup') return 'FOLLOW UP ⚠️';
      if(key==='no_show') return 'NO SHOW ⚠️';
      if(key==='objection') return 'OBJECTION ❌';
      if(key==='fail') return 'FAIL ❌';
      return 'UNKNOWN';
    }
    function outcomePillClass(key){
      if(key==='booked' || key==='pass') return 'win';
      if(key==='followup' || key==='no_show') return 'followup';
      if(key==='objection' || key==='fail') return 'loss';
      return 'unknown';
    }
    const outcomeGlossary = {
      booked: 'Prospect agreed to a defined next step (meeting, demo, walkthrough, calendar commitment).',
      pass: 'Prospect affirmed relevance or requested the next step, even if scheduling specifics aren’t captured.',
      followup: 'Prospect didn’t commit, but left the door open (asked to send info, check back later, or review).',
      no_show: 'Prospect disengaged or the call ended without a meaningful exchange.',
      objection: 'Prospect explicitly rejected or raised a blocking objection not resolved in-call.',
      fail: 'Call broke down (rambling, no control, no qualification, no clear ask).',
      unknown: 'Outcome wasn’t clear from the transcript + context.'
    };

    // --------- markdown-ish parser for report sections ----------
    function splitReportIntoSections(reportText){
      const text = (reportText||'').trim();
      if(!text) return [];
      const lines = text.split(/\r?\n/);
      const sections = [];
      let cur = { title: 'Report', body: [] };

      const h2 = /^##\s+(.*)\s*$/;
      for(const ln of lines){
        const m = ln.match(h2);
        if(m){
          if(cur.body.length || cur.title) sections.push({ title: cur.title, body: cur.body.join('\n').trim() });
          cur = { title: m[1].trim(), body: [] };
        }else{
          cur.body.push(ln);
        }
      }
      if(cur.body.length || cur.title) sections.push({ title: cur.title, body: cur.body.join('\n').trim() });

      return sections.filter(s => (s.title || '').trim() || (s.body || '').trim());
    }

    function renderMdToHtml(md){
      const lines = (md||'').split(/\r?\n/);
      let html = '';
      let inList = false;

      function closeList(){ if(inList){ html += '</ul>'; inList=false; } }

      for(let raw of lines){
        const line = raw.trimRight();

        // list item
        const li = line.match(/^\s*[-*]\s+(.*)$/) || line.match(/^\s*\d+\.\s+(.*)$/);
        if(li){
          if(!inList){ html += '<ul>'; inList=true; }
          html += '<li>' + escapeHtml(li[1]) + '</li>';
          continue;
        } else {
          closeList();
        }

        if(!line.trim()){
          continue;
        }

        // bold **text**
        let safe = escapeHtml(line);
        safe = safe.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
        safe = safe.replace(/`(.+?)`/g, '<span class="mono">$1</span>');

        html += '<p>' + safe + '</p>';
      }
      closeList();
      return html;
    }

    function stripMdFormatting(s){
      return String(s||'')
        .replace(/^\s*[-*]\s+/,'')
        .replace(/^\s*\d+\.\s+/,'')
        .replace(/[*_`>#]/g,'')
        .replace(/\s+/g,' ')
        .trim();
    }

    function extractBulletItems(md){
      const items = [];
      const lines = String(md||'').split(/\r?\n/);
      for(const raw of lines){
        const m = raw.match(/^\s*[-*]\s+(.*)$/) || raw.match(/^\s*\d+\.\s+(.*)$/);
        if(m){
          const cleaned = stripMdFormatting(m[1]);
          if(cleaned) items.push(cleaned);
        }
      }
      return items;
    }

    function extractTopFixesFromReport(reportText){
      const txt = String(reportText||'').trim();
      if(!txt) return [];
      const sections = splitReportIntoSections(txt);

      // Prefer sections whose headings imply priority fixes.
      const preferred = sections.find(s => /fix|priority|priorities|top\s*3|do this first|first/i.test((s.title||'').toLowerCase()));
      let pool = preferred ? preferred.body : txt;

      let items = extractBulletItems(pool);

      // If not enough, search all sections in order.
      if(items.length < 3){
        for(const sec of sections){
          const more = extractBulletItems(sec.body);
          items = items.concat(more);
          if(items.length >= 3) break;
        }
      }

      // Deduplicate.
      const seen = new Set();
      items = items.filter(x => {
        const k = x.toLowerCase();
        if(seen.has(k)) return false;
        seen.add(k);
        return true;
      });

      // Fallback: take first sentences.
      if(items.length < 3){
        const plain = txt.replace(/[#*_`>-]/g,' ').replace(/\s+/g,' ').trim();
        const sents = plain.split(/(?<=[.!?])\s+/).filter(Boolean);
        for(const s of sents){
          const cleaned = stripMdFormatting(s);
          if(cleaned) items.push(cleaned);
          if(items.length >= 3) break;
        }
      }
      return items.slice(0, 3);
    }

    function enforceTwoLine(text){
      let t = String(text||'').trim();
      if(!t) return '';
      t = t.replace(/^["'“”]+|["'“”]+$/g, '').trim();
      const sentences = t.split(/(?<=[.!?])\s+/).filter(Boolean);
      if(sentences.length >= 2){
        const line1 = sentences[0].trim();
        const line2 = sentences.slice(1).join(' ').trim();
        return (line1 + '\n' + line2).trim();
      }
      const words = t.split(/\s+/).filter(Boolean);
      if(words.length > 18){
        const mid = Math.min(18, Math.ceil(words.length/2));
        return (words.slice(0, mid).join(' ') + '\n' + words.slice(mid).join(' ')).trim();
      }
      return t;
    }

    // --------- script guesser (used for playbook + follow-up) ----------
    function guessScriptFromReport(reportText){
      const sections = splitReportIntoSections(reportText || '');
      const cand = sections.find(s => /follow up|two-line|two line|message|dm|email|text/i.test(s.title||'')) || sections.find(s => /script|send|write/i.test(s.title||''));
      const body = (cand ? cand.body : (reportText||''));
      const lines = body.split(/\r?\n/).map(l => l.trim()).filter(Boolean);

      // find a line that looks like a draft message
      for(const ln of lines){
        if(ln.length >= 35 && ln.length <= 220 && !ln.startsWith('-') && !ln.match(/^\d+\./)){
          if(!ln.toLowerCase().includes('section') && !ln.toLowerCase().includes('enforcer')){
            return ln.replace(/^["'“”]+|["'“”]+$/g,'').trim();
          }
        }
      }

      // fallback: take first bullet-ish items and stitch into 2 lines
      const bullets = extractBulletItems(body);
      if(bullets.length){
        const a = bullets[0] || '';
        const b = bullets[1] || '';
        return [a,b].filter(Boolean).join(' ');
      }

      // last fallback
      const plain = (reportText||'').replace(/[#*_`>-]/g,' ').replace(/\s+/g,' ').trim();
      return plain.slice(0, 200);
    }

    function maxWords(s, n){
      const w = (s||'').trim().split(/\s+/).filter(Boolean);
      return w.slice(0, n).join(' ');
    }

    async function copyToClipboard(text){
      const t = String(text||'');
      if(!t.trim()){
        toast('Nothing to copy.');
        return;
      }
      try{
        await navigator.clipboard.writeText(t);
        toast('Copied.');
      }catch{
        // fallback
        const ok = window.prompt('Copy to clipboard:', t);
        if(ok !== null) toast('Copied.');
      }
    }

    // --------- views ----------
    routes['/'] = renderHome;
    routes['/run'] = renderRun;
    routes['/playbook'] = renderPlaybook;

    function renderRoute(){
      const path = location.pathname;
      setActiveNav(path);
      if(path.startsWith('/run/')){
        const id = path.split('/')[2];
        return renderRun({ runId: id });
      }
      if(path.startsWith('/playbook')){
        return renderPlaybook();
      }
      return renderHome();
    }

    // ---------- HOME ----------
    async function renderHome(){
      viewRoot.innerHTML = `
        <div class="grid">
          <div class="card">
            <div class="cardInner">
              <div class="h1">Upload + Analyze</div>
              <div class="muted">Audio + context in, transcript + coaching out. Keep it short — we infer prospect details from the transcript when possible.</div>

              <div class="divider"></div>

              <label>Audio file</label>
              <input type="file" class="field" id="audioFile" accept="audio/*" />

              <label>Scenario template (optional)</label>
              <select id="scenario" class="field">
                <option value="none">None</option>
                <option value="b2b">B2B service / software</option>
                <option value="retail">Local service / retail</option>
                <option value="recruiting">Recruiting / staffing</option>
              </select>
              <div class="hint" id="scenarioHint"></div>

              <label>Legacy scenario (optional)</label>
              <select id="legacyScenario" class="field">
                <option value="none">None</option>
                <option value="seo">SEO</option>
                <option value="maintenance">Maintenance</option>
                <option value="ai_receptionist">AI receptionist</option>
              </select>
              <div class="hint">Kept for backwards compatibility during MVP.</div>

              <label>Context (required)</label>
              <textarea id="context" class="field" placeholder="e.g., Selling SEO service to an ecommerce beauty store."></textarea>

              <div class="row" style="margin-top:12px;">
                <button class="btn" id="btnRun">
                  <span>Calibrate</span>
                  <span class="badge" id="btnRunBadge">Ready</span>
                </button>
                <button class="btn secondary" id="btnClear">Clear</button>
              </div>

              <div class="hint mono" id="statusLine" style="margin-top:10px;"></div>
            </div>
          </div>

          <div class="card">
            <div class="cardInner">
              <div class="h1">History</div>
              <div class="muted">Your most recent runs. Click any run to open its report.</div>

              <div class="divider"></div>

              <div class="list" id="runsList"></div>
              <div class="hint" id="runsHint"></div>
            </div>
          </div>
        </div>
      `;

      const scenarioEl = document.getElementById('scenario');
      const scenarioHint = document.getElementById('scenarioHint');
      const updateHint = () => {
        const v = scenarioEl.value;
        scenarioHint.textContent = scenarioTemplates[v]?.helper || '';
      };
      scenarioEl.addEventListener('change', updateHint);
      updateHint();

      const btnRun = document.getElementById('btnRun');
      const btnRunBadge = document.getElementById('btnRunBadge');
      const statusLine = document.getElementById('statusLine');

      document.getElementById('btnClear').onclick = () => {
        document.getElementById('audioFile').value = '';
        document.getElementById('context').value = '';
        document.getElementById('legacyScenario').value = 'none';
        document.getElementById('scenario').value = 'none';
        updateHint();
        statusLine.textContent = '';
        toast('Cleared.');
      };

      btnRun.onclick = async () => {
        const file = document.getElementById('audioFile').files?.[0];
        const context = document.getElementById('context').value.trim();
        const scenario = document.getElementById('scenario').value;
        const legacyScenario = document.getElementById('legacyScenario').value;

        if(!file){ toast('Choose an audio file.'); return; }
        if(!context){ toast('Add context.'); return; }

        btnRun.disabled = true;
        btnRunBadge.textContent = 'Working…';
        statusLine.textContent = 'Uploading + running analysis…';

        try{
          const fd = new FormData();
          fd.append('audio', file);
          fd.append('context', context);
          fd.append('scenario', scenario);
          fd.append('legacy_scenario', legacyScenario);

          const res = await apiUpload('/api/run', fd);

          statusLine.textContent = 'Done ✅ Opening report…';
          btnRunBadge.textContent = 'Done';
          toast('Done ✅');
          goto('/run/' + res.run_id);
        }catch(e){
          console.error(e);
          statusLine.textContent = 'Error: ' + (e?.message || e);
          btnRunBadge.textContent = 'Error';
          toast('Error running analysis.');
        }finally{
          btnRun.disabled = false;
          setTimeout(()=> btnRunBadge.textContent = 'Ready', 900);
        }
      };

      await loadRunsList();
    }

    async function loadRunsList(){
      const runsList = document.getElementById('runsList');
      const runsHint = document.getElementById('runsHint');

      runsList.innerHTML = '<div class="small">Loading…</div>';
      runsHint.textContent = '';

      try{
        const data = await apiGet('/api/runs');
        const runs = data?.runs || [];

        if(!runs.length){
          runsList.innerHTML = '';
          runsHint.textContent = 'No runs yet.';
          return;
        }

        runsList.innerHTML = '';
        for(const r of runs){
          const el = document.createElement('div');
          el.className = 'listItem';
          const when = fmtDate(r.created_at);
          const scenarioLabel = (scenarioTemplates[r.scenario]?.label) || (r.scenario || 'None');
          const outcomeKey = normalizeOutcomeKey(r.call_outcome);
          const pill = `<span class="outcomePill ${outcomePillClass(outcomeKey)} hasTip" data-tip="${escapeHtml(outcomeGlossary[outcomeKey] || outcomeGlossary.unknown)}">${escapeHtml(outcomeLabel(outcomeKey))}</span>`;
          el.innerHTML = `
            <div class="liLeft">
              <div class="liTitle">${escapeHtml(r.title || 'Untitled run')}</div>
              <div class="liMeta">
                <span>${escapeHtml(when)}</span>
                <span>•</span>
                <span>${escapeHtml(scenarioLabel)}</span>
              </div>
            </div>
            <div class="liRight">
              ${pill}
              <div class="chev">›</div>
            </div>
          `;
          el.onclick = () => goto('/run/' + r.id);
          runsList.appendChild(el);
        }

      }catch(e){
        console.error(e);
        runsList.innerHTML = '';
        runsHint.textContent = 'Could not load runs.';
      }
    }

    // ---------- RUN VIEW ----------
    async function renderRun({ runId }){
      viewRoot.innerHTML = `
        <div class="card">
          <div class="cardInner">
            <div class="row" style="justify-content:space-between; align-items:flex-start;">
              <div style="min-width:0">
                <div class="h1" id="runTitle">Run</div>
                <div class="muted" id="runMeta"></div>
              </div>
              <div class="row">
                <button class="btn secondary" id="btnSavePlaybook">Save to Playbook</button>
                <button class="btn secondary" onclick="goto('/')">Back</button>
              </div>
            </div>

            <div id="runBanners"></div>

            <!-- NEW: 3 main panels -->
            <div class="triGrid" id="triGrid">
              <div class="panel center" id="panelResult">
                <div class="panelHead">
                  <p class="panelTitle">Call Result</p>
                  <span id="outcomePillBigWrap"></span>
                </div>
                <div class="panelBody">
                  <div class="outcomeBig" id="callResultLabel">—</div>
                  <div class="outcomeReason" id="callResultReason">—</div>
                  <div class="pbSmall" id="callResultEvidence" style="display:none;"></div>
                  <div class="metaRow">
                    <span class="pill" id="metaScenario" style="background:rgba(255,255,255,.86); cursor:default;"></span>
                    <span class="pill" id="metaSubmitted" style="background:rgba(255,255,255,.86); cursor:default;"></span>
                  </div>
                </div>
              </div>

              <div class="panel" id="panelFollowUp">
                <div class="panelHead">
                  <p class="panelTitle">Send this follow-up</p>
                  <div class="panelBtns">
                    <button class="btn secondary small" id="btnCopyFollowUp">Copy</button>
                    <button class="btn small" id="btnUseInPlaybook">Save</button>
                  </div>
                </div>
                <div class="panelBody">
                  <textarea id="followUpText" class="field" style="min-height:110px; resize:vertical"></textarea>
                  <div class="pbSmall" id="followUpHint">Generated from your coaching report.</div>
                </div>
              </div>

              <div class="panel" id="panelFixes">
                <div class="panelHead">
                  <p class="panelTitle">Fix these first</p>
                  <div class="panelBtns">
                    <button class="btn secondary small" id="btnCopyFixes">Copy</button>
                  </div>
                </div>
                <div class="panelBody">
                  <div id="fixList" class="fixList"></div>
                  <div class="pbSmall" id="fixHint">Top 3 priorities pulled from the report.</div>
                </div>
              </div>
            </div>

            <div style="height:12px;"></div>

            <h3 class="sectionTitle">Context</h3>
            <div class="kv" id="summaryKV2"></div>

            <div class="divider"></div>

            <h3 class="sectionTitle">Transcript</h3>
            <div class="transcript" id="transcript"></div>

            <div class="divider"></div>

            <h3 class="sectionTitle">Full Coaching Report</h3>
            <div id="report"></div>

          </div>
        </div>
      `;

      const runTitleEl = document.getElementById('runTitle');
      const runMetaEl = document.getElementById('runMeta');
      const summaryKVEl2 = document.getElementById('summaryKV2');
      const transcriptEl = document.getElementById('transcript');
      const reportEl = document.getElementById('report');
      const runBanners = document.getElementById('runBanners');

      const btnSavePlaybook = document.getElementById('btnSavePlaybook');

      const outcomePillBigWrap = document.getElementById('outcomePillBigWrap');
      const callResultLabel = document.getElementById('callResultLabel');
      const callResultReason = document.getElementById('callResultReason');
      const callResultEvidence = document.getElementById('callResultEvidence');
      const metaScenario = document.getElementById('metaScenario');
      const metaSubmitted = document.getElementById('metaSubmitted');

      const followUpText = document.getElementById('followUpText');
      const btnCopyFollowUp = document.getElementById('btnCopyFollowUp');
      const btnUseInPlaybook = document.getElementById('btnUseInPlaybook');

      const fixList = document.getElementById('fixList');
      const btnCopyFixes = document.getElementById('btnCopyFixes');

      let currentRun = null;

      function renderSummaryInto(el, run){
        const scenarioLabel = scenarioTemplates[run.scenario]?.label || run.scenario || 'None';
        const legacyLabel = legacyScenarioMap[run.legacy_scenario] || run.legacy_scenario || 'None';

        const items = [
          { k:'Scenario (selected)', v: scenarioLabel, sub: scenarioTemplates[run.scenario]?.helper || '' },
          { k:'Legacy scenario (optional)', v: legacyLabel, sub:'Kept for backwards compatibility during MVP.' },
          { k:'User Context', v: run.context || '', sub:'' },
          { k:'Enforcer', v: run.enforcer_version || '—', sub:'' }
        ];
        el.innerHTML = '';
        for(const it of items){
          const div = document.createElement('div');
          div.className = 'kvItem';
          div.innerHTML = `
            <div class="kvK">${escapeHtml(it.k)}</div>
            <div class="kvV">${escapeHtml(it.v || '—')}</div>
            ${it.sub ? `<div class="kvV sub">${escapeHtml(it.sub)}</div>` : ''}
          `;
          el.appendChild(div);
        }
      }

      function renderTranscript(run){
        transcriptEl.innerHTML = '';
        const t = (run.transcript_text || '').trim();
        if(!t){
          transcriptEl.innerHTML = '<div class="small">No transcript available.</div>';
          return;
        }
        // parse "Speaker X:" lines
        const lines = t.split(/\r?\n/).filter(Boolean);
        for(const raw of lines){
          const m = raw.match(/^([^:]{1,30}):\s*(.*)$/);
          if(m){
            const who = m[1].trim();
            const text = m[2].trim();
            const line = document.createElement('div');
            line.className = 'tLine';

            const chip = document.createElement('div');
            chip.className = 'tChip';
            // heuristic: label mapping is already done server-side (You / Prospect)
            const low = who.toLowerCase();
            if(low.includes('you') || low.includes('rep')) chip.classList.add('you');
            if(low.includes('prospect') || low.includes('customer')) chip.classList.add('pro');

            chip.textContent = who;

            const bubble = document.createElement('div');
            bubble.className = 'tText';
            bubble.textContent = text;

            line.appendChild(chip);
            line.appendChild(bubble);
            transcriptEl.appendChild(line);
          }else{
            // fallback: treat as continuation
            const line = document.createElement('div');
            line.className = 'tLine';
            const bubble = document.createElement('div');
            bubble.className = 'tText';
            bubble.style.marginLeft = '0';
            bubble.textContent = raw.trim();
            line.appendChild(document.createElement('div')); // spacer
            line.appendChild(bubble);
            transcriptEl.appendChild(line);
          }
        }
      }

      function renderReport(run){
        reportEl.innerHTML = '';
        const text = (run.report_text || '').trim();
        if(!text){
          reportEl.innerHTML = '<div class="small">No report available.</div>';
          return;
        }

        const sections = splitReportIntoSections(text);
        if(!sections.length){
          reportEl.innerHTML = `<div class="reportBody">${renderMdToHtml(text)}</div>`;
          return;
        }

        let idx=0;
        for(const s of sections){
          const det = document.createElement('details');
          // open first section by default
          if(idx===0) det.open = true;

          const sum = document.createElement('summary');
          sum.innerHTML = `
            <span>${escapeHtml(s.title || 'Section')}</span>
            <span class="badge">${idx===0 ? 'Open' : 'Details'}</span>
          `;

          const body = document.createElement('div');
          body.className = 'reportBody';
          body.innerHTML = renderMdToHtml(s.body);

          det.appendChild(sum);
          det.appendChild(body);
          reportEl.appendChild(det);

          idx++;
        }
      }

      function renderBanners(run){
        runBanners.innerHTML = '';
        const banners = [];

        if(run.scenario_mismatch){
          banners.push({
            kind:'warn',
            title:'⚠ SCENARIO MISMATCH',
            desc: run.mismatch_reason || 'Selected scenario does not match transcript content.'
          });
        }

        // show a banner if transcript is missing or very short
        const t = (run.transcript_text||'').trim();
        if(!t || t.length < 60){
          banners.push({
            kind:'bad',
            title:'Transcript may be incomplete',
            desc:'We couldn’t extract enough dialogue. Try a clearer recording or a longer segment.'
          });
        }

        for(const b of banners){
          const el = document.createElement('div');
          el.className = 'banner';
          el.innerHTML = `
            <div class="bannerIcon ${b.kind}">${b.kind==='warn'?'!':b.kind==='bad'?'×':'✓'}</div>
            <div class="bannerText">
              <div class="bannerTitle">${escapeHtml(b.title)}</div>
              <div class="bannerDesc">${escapeHtml(b.desc)}</div>
            </div>
          `;
          runBanners.appendChild(el);
        }
      }

      function renderTopPanels(run){
        const scenarioLabel = scenarioTemplates[run.scenario]?.label || run.scenario || 'None';
        const when = fmtDate(run.created_at);

        const outcomeKey = normalizeOutcomeKey(run.call_outcome);
        const label = outcomeLabel(outcomeKey);
        const tip = outcomeGlossary[outcomeKey] || outcomeGlossary.unknown;

        callResultLabel.textContent = label;
        callResultReason.textContent = (run.call_outcome_reason || tip || '—').trim();

        // evidence if present
        const ev = (run.call_outcome_evidence || '').trim();
        if(ev){
          callResultEvidence.style.display = '';
          callResultEvidence.textContent = 'Evidence: ' + ev;
        }else{
          callResultEvidence.style.display = 'none';
          callResultEvidence.textContent = '';
        }

        // colored pill at top right
        outcomePillBigWrap.innerHTML = '';
        const p = document.createElement('span');
        p.className = `outcomePill ${outcomePillClass(outcomeKey)} hasTip`;
        p.setAttribute('data-tip', tip);
        p.textContent = label;
        outcomePillBigWrap.appendChild(p);

        metaScenario.textContent = `Scenario: ${scenarioLabel}`;
        metaSubmitted.textContent = when ? `Submitted: ${when}` : 'Submitted: —';

        // follow-up (two-line)
        const fu = enforceTwoLine(guessScriptFromReport(run.report_text || ''));
        followUpText.value = fu || '';

        // top fixes
        const fixes = extractTopFixesFromReport(run.report_text || '');
        fixList.innerHTML = '';
        if(!fixes.length){
          const empty = document.createElement('div');
          empty.className = 'small';
          empty.textContent = 'No clear priorities detected in the report.';
          fixList.appendChild(empty);
        }else{
          fixes.forEach((txt, i) => {
            const item = document.createElement('div');
            item.className = 'fixItem';
            item.innerHTML = `
              <div class="fixNum">${i+1}</div>
              <div class="fixText">${escapeHtml(txt)}</div>
            `;
            fixList.appendChild(item);
          });
        }
      }

      btnCopyFollowUp.onclick = () => copyToClipboard(followUpText.value);
      btnCopyFixes.onclick = () => {
        const fixes = Array.from(fixList.querySelectorAll('.fixText')).map(x => x.textContent.trim()).filter(Boolean);
        if(!fixes.length){ toast('Nothing to copy.'); return; }
        const text = fixes.map((f,i)=> `${i+1}. ${f}`).join('\n');
        copyToClipboard(text);
      };

      btnUseInPlaybook.onclick = () => {
        if(!currentRun){ toast('Run not loaded yet.'); return; }
        const txt = followUpText.value.trim();
        if(!txt){ toast('Follow-up is empty.'); return; }
        const base = maxWords((currentRun.title || 'Follow Up'), 4);
        const title = maxWords((base ? base + ' ' : '') + 'Follow Up', 5) || 'Follow Up';
        pbDraft = { title, text: txt, notes: '' };
        toast('Ready to save in Playbook.');
        goto('/playbook');
      };

      btnSavePlaybook.onclick = () => {
        if(!currentRun){ toast('Run not loaded yet.'); return; }
        // Save the report-derived script (existing behavior)
        const title = maxWords((currentRun.title || 'Script'), 5) || 'Script';
        const text = guessScriptFromReport(currentRun.report_text || '');
        pbDraft = { title, text, notes:'' };
        toast('Ready to save in Playbook.');
        goto('/playbook');
      };

      // load run
      try{
        const data = await apiGet('/api/runs/' + runId);
        const run = data?.run;
        currentRun = run;

        runTitleEl.textContent = run.title || 'Run';
        const scenarioLabel = scenarioTemplates[run.scenario]?.label || run.scenario || 'None';
        runMetaEl.innerHTML = `
          <span class="badge">${escapeHtml(scenarioLabel)}</span>
          <span class="badge">${escapeHtml(fmtDate(run.created_at))}</span>
        `;

        renderBanners(run);
        renderTopPanels(run);
        renderSummaryInto(summaryKVEl2, run);
        renderTranscript(run);
        renderReport(run);

      }catch(e){
        console.error(e);
        toast('Could not load run.');
        viewRoot.innerHTML = `
          <div class="card"><div class="cardInner">
            <div class="h1">Could not load run</div>
            <div class="muted">${escapeHtml(e?.message || String(e))}</div>
            <div class="divider"></div>
            <button class="btn secondary" onclick="goto('/')">Back</button>
          </div></div>
        `;
      }
    }

    // ---------- PLAYBOOK ----------
    // Simple: list scripts, view/edit current, add versions.
    let pbSelectedId = null;
    let pbDraft = null;

    async function renderPlaybook(){
      viewRoot.innerHTML = `
        <div class="card">
          <div class="cardInner">
            <div class="row" style="justify-content:space-between; align-items:flex-start;">
              <div>
                <div class="h1">Playbook</div>
                <div class="muted">Save your best follow-ups and scripts. Add new versions as you improve them.</div>
              </div>
              <div class="row">
                <button class="btn secondary" id="btnPbNew">New Script</button>
                <button class="btn secondary" onclick="goto('/')">Back</button>
              </div>
            </div>

            <div class="divider"></div>

            <div class="pbLayout">
              <div>
                <h3 class="sectionTitle">Scripts</h3>
                <div class="pbList" id="pbList"></div>
                <div class="hint" id="pbHint"></div>
              </div>

              <div>
                <h3 class="sectionTitle">Editor</h3>
                <div class="pbEditor">
                  <div class="row">
                    <div style="display:flex; flex-direction:column; gap:6px; flex:1;">
                      <input class="field" id="pbTitle" placeholder="Title (max 5 words)" />
                      <div class="pbSmall">Tip: Keep titles short. You can add versions for iteration.</div>
                    </div>
                    <div class="row">
                      <button class="btn secondary" id="btnPbCopy">Copy</button>
                      <button class="btn" id="btnPbSave">Save</button>
                    </div>
                  </div>

                  <label>Script text</label>
                  <textarea id="pbText" class="field" placeholder="Write a script…"></textarea>

                  <label>Version notes (optional)</label>
                  <input id="pbNotes" class="field" placeholder="What changed? (e.g., tighter opener, clearer ask)" />

                  <div class="row" style="margin-top:10px;">
                    <button class="btn secondary" id="btnPbAddVersion">Add as New Version</button>
                  </div>

                  <div class="divider"></div>
                  <h3 class="sectionTitle">Versions</h3>
                  <div class="pbVersions" id="pbVersions"></div>
                </div>
              </div>

            </div>
          </div>
        </div>
      `;

      const pbListEl = document.getElementById('pbList');
      const pbHintEl = document.getElementById('pbHint');
      const pbTitleEl = document.getElementById('pbTitle');
      const pbTextEl = document.getElementById('pbText');
      const pbNotesEl = document.getElementById('pbNotes');
      const pbVersionsEl = document.getElementById('pbVersions');

      const btnPbNew = document.getElementById('btnPbNew');
      const btnPbCopy = document.getElementById('btnPbCopy');
      const btnPbSave = document.getElementById('btnPbSave');
      const btnPbAddVersion = document.getElementById('btnPbAddVersion');

      function setEditor({ title, text }){
        pbTitleEl.value = title || '';
        pbTextEl.value = text || '';
        pbNotesEl.value = '';
      }

      async function loadScripts(){
        pbListEl.innerHTML = '<div class="small">Loading…</div>';
        pbHintEl.textContent = '';
        try{
          const data = await apiGet('/api/playbook/scripts');
          const scripts = data?.scripts || [];
          pbListEl.innerHTML = '';

          if(!scripts.length){
            pbHintEl.textContent = 'No scripts yet.';
          }

          for(const s of scripts){
            const item = document.createElement('div');
            item.className = 'pbItem' + (s.id===pbSelectedId ? ' active' : '');
            item.innerHTML = `
              <div class="pbTop">
                <div style="min-width:0">
                  <div class="pbTitle">${escapeHtml(s.title || 'Untitled')}</div>
                  <div class="pbMeta">Updated: ${escapeHtml(fmtDate(s.updated_at))}</div>
                </div>
                <span class="badge">${escapeHtml((s.version_count||0) + ' ver')}</span>
              </div>
            `;
            item.onclick = async () => {
              pbSelectedId = s.id;
              await openScript(s.id);
            };
            pbListEl.appendChild(item);
          }

        }catch(e){
          console.error(e);
          pbListEl.innerHTML = '';
          pbHintEl.textContent = 'Could not load playbook.';
        }
      }

      async function openScript(id){
        try{
          const data = await apiGet('/api/playbook/scripts/' + id);
          const script = data?.script;
          const versions = data?.versions || [];
          if(!script) return;

          setEditor({ title: script.title, text: script.current_text || '' });

          // versions list
          pbVersionsEl.innerHTML = '';
          for(const v of versions){
            const ver = document.createElement('div');
            ver.className = 'pbVer';
            ver.innerHTML = `
              <div class="pbVerLeft">
                <div class="pbVerTitle">v${escapeHtml(String(v.version_number))}</div>
                <div class="pbVerMeta">${escapeHtml(fmtDate(v.created_at))}${v.notes ? ' • ' + escapeHtml(v.notes) : ''}</div>
              </div>
              <div class="row">
                <button class="btn secondary pbVerBtn">Load</button>
              </div>
            `;
            ver.querySelector('button').onclick = () => {
              pbTextEl.value = v.text || '';
              pbNotesEl.value = v.notes || '';
              toast('Loaded v' + v.version_number);
            };
            pbVersionsEl.appendChild(ver);
          }

          // refresh list highlight
          await loadScripts();
        }catch(e){
          console.error(e);
          toast('Could not open script.');
        }
      }

      async function createPlaybookScript(){
        const title = maxWords(pbTitleEl.value, 5);
        const text = pbTextEl.value.trim();
        const notes = pbNotesEl.value.trim();

        if(!title){ toast('Add a title (max 5 words).'); return; }
        if(!text){ toast('Add script text.'); return; }

        const res = await apiPost('/api/playbook/scripts', { title, text, source_run_id: null, notes });
        pbSelectedId = res.script_id;
        toast('Saved.');
        await openScript(pbSelectedId);
      }

      async function addPlaybookVersion(){
        if(!pbSelectedId){ toast('Select a script first.'); return; }
        const text = pbTextEl.value.trim();
        const notes = pbNotesEl.value.trim();

        if(!text){ toast('Script text is empty.'); return; }

        await apiPost('/api/playbook/scripts/' + pbSelectedId + '/versions', { text, notes });
        toast('Added version.');
        await openScript(pbSelectedId);
      }

      btnPbCopy.onclick = () => copyToClipboard(pbTextEl.value);
      btnPbSave.onclick = createPlaybookScript;
      btnPbAddVersion.onclick = addPlaybookVersion;

      btnPbNew.onclick = () => {
        pbSelectedId = null;
        setEditor({ title:'', text:'' });
        toast('New script.');
        loadScripts();
      };

      // If we arrived with a draft from Run view, preload it.
      if(pbDraft){
        setEditor({ title: pbDraft.title, text: pbDraft.text });
        pbNotesEl.value = pbDraft.notes || '';
        pbDraft = null;
        pbSelectedId = null;
        btnPbSave.textContent = 'Save as New Script';
      } else {
        btnPbSave.textContent = 'Save';
      }

      await loadScripts();

      // auto-open first script if none selected and exists
      try{
        const data = await apiGet('/api/playbook/scripts');
        const scripts = data?.scripts || [];
        if(!pbSelectedId && scripts.length){
          pbSelectedId = scripts[0].id;
          await openScript(pbSelectedId);
        }
      }catch{}
    }

    // init
    renderRoute();
  </script>
</body>
</html>
