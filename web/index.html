<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Calibrate</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --bg:#ffffff;
      --panel:#ffffff;
      --muted:#f5f7fb;
      --border:#e6eaf2;
      --text:#0b1220;
      --sub:#5b6475;
      --blue:#2563eb;
      --blue2:#1d4ed8;
      --good:#16a34a;
      --warn:#f59e0b;
      --bad:#dc2626;
      --shadow: 0 8px 22px rgba(10,20,40,.08);
      --r:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: var(--bg);
      color: var(--text);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:22px}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;
      padding:14px 18px;border:1px solid var(--border);border-radius:var(--r);
      background:var(--panel); box-shadow: var(--shadow);
    }
    .brand{display:flex;align-items:center;gap:10px}
    .logo{
      width:36px;height:36px;border-radius:12px;
      background: linear-gradient(135deg, var(--blue), #60a5fa);
      box-shadow:0 10px 20px rgba(37,99,235,.25);
    }
    .brand h1{font-size:16px;margin:0;font-weight:800;letter-spacing:.2px}
    .brand .tag{font-size:12px;color:var(--sub);margin-top:2px}
    .right{display:flex;align-items:center;gap:10px}
    .pill{
      font-size:12px;border:1px solid var(--border);padding:8px 10px;border-radius:999px;background:#fff;
      color:var(--sub)
    }
    .btn{
      border:1px solid var(--border);
      background:#fff;color:var(--text);
      padding:10px 12px;border-radius:12px;
      font-weight:700;cursor:pointer;
    }
    .btn.primary{
      background: var(--blue);
      border-color: var(--blue);
      color:#fff;
    }
    .btn.primary:hover{background:var(--blue2)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .grid{
      display:grid;grid-template-columns: 1fr;
      gap:14px;margin-top:14px;
    }
    .card{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding:16px;
    }
    .card h2{margin:0 0 10px 0;font-size:14px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:14px}
    .tab{
      padding:10px 12px;border-radius:999px;border:1px solid var(--border);
      background:#fff;font-weight:800;font-size:12px;color:var(--sub);cursor:pointer;
    }
    .tab.active{background:var(--muted);color:var(--text);border-color:var(--border)}
    label{display:block;font-size:12px;color:var(--sub);margin:10px 0 6px}
    input, select, textarea{
      width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);
      outline:none;background:#fff;font-size:14px;color:var(--text);
    }
    textarea{min-height:90px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    .muted{color:var(--sub);font-size:12px;line-height:1.35}
    .hr{height:1px;background:var(--border);margin:14px 0}
    .kpi{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
    .badge{
      border:1px solid var(--border);
      padding:8px 10px;border-radius:999px;
      font-size:12px;font-weight:800;background:var(--muted);
    }
    .big{
      display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap;
    }
    .result{
      display:flex;flex-direction:column;gap:6px;
    }
    .result .label{font-weight:900;font-size:18px}
    .scorebox{
      display:flex;flex-direction:column;align-items:flex-end;gap:6px;min-width:160px;
    }
    .grade{
      font-weight:1000;font-size:18px;
      padding:10px 12px;border-radius:14px;border:1px solid var(--border);
      background:var(--muted);
    }
    .grade.A{border-color:#bbf7d0;background:#f0fdf4}
    .grade.B{border-color:#d9f99d;background:#f7fee7}
    .grade.C{border-color:#fde68a;background:#fffbeb}
    .grade.D,.grade.F{border-color:#fecaca;background:#fef2f2}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}
    .listItem{
      border:1px solid var(--border);
      background:#fff;border-radius:14px;padding:12px;margin-top:10px;
    }
    .listItem .t{font-weight:900}
    .listItem .s{color:var(--sub);font-size:12px;margin-top:6px;line-height:1.35}
    details{
      border:1px solid var(--border);border-radius:14px;padding:10px;background:#fff;
    }
    summary{cursor:pointer;font-weight:900}
    pre{
      white-space:pre-wrap;word-wrap:break-word;
      background:var(--muted);border:1px solid var(--border);
      padding:12px;border-radius:14px;margin:10px 0 0 0;
      font-size:12px;line-height:1.35;
    }
    .toast{
      position:fixed;left:50%;transform:translateX(-50%);
      bottom:18px;background:#0b1220;color:#fff;
      padding:10px 12px;border-radius:999px;font-size:12px;
      box-shadow:0 14px 40px rgba(0,0,0,.22);
      display:none;
    }
    .authWrap{max-width:520px;margin:22px auto}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Calibrate</h1>
          <div class="tag">Post-call command center</div>
        </div>
      </div>
      <div class="right">
        <div class="pill" id="pillUser">Not signed in</div>
        <button class="btn" id="btnSignOut" style="display:none">Sign out</button>
      </div>
    </div>

    <div id="authView" class="authWrap" style="display:none">
      <div class="card">
        <h2>Sign in</h2>
        <div class="muted">
          Enter your email. We’ll send a magic link. This is the landing experience new users should see.
        </div>
        <label>Email</label>
        <input id="authEmail" type="email" placeholder="you@domain.com" />
        <div style="display:flex;gap:10px;margin-top:10px">
          <button class="btn primary" id="btnSendLink">Send magic link</button>
          <button class="btn" id="btnRefreshSession">I already clicked the link</button>
        </div>
        <div class="muted" style="margin-top:10px" id="authMsg"></div>
      </div>
    </div>

    <div id="appView" style="display:none">
      <div class="tabs">
        <button class="tab active" data-tab="upload">Upload Call</button>
        <button class="tab" data-tab="runs">Runs</button>
        <button class="tab" data-tab="entities">Entities</button>
        <button class="tab" data-tab="playbook">Playbook</button>
      </div>

      <div class="grid">
        <div id="tab-upload" class="card">
          <h2>Upload Call</h2>
          <div class="muted">Accepts audio (mp3/wav/m4a) and video (mp4/mov). Video is auto-extracted to audio on the server.</div>

          <label>File</label>
          <input id="file" type="file" accept=".mp3,.wav,.m4a,.mp4,.mov,video/*,audio/*" />

          <div class="row">
            <div>
              <label>Scenario (optional)</label>
              <input id="scenario" placeholder="B2B service / software" />
            </div>
            <div>
              <label>Entity (optional)</label>
              <select id="entitySelect">
                <option value="">None</option>
              </select>
            </div>
          </div>

          <details style="margin-top:10px">
            <summary>Create new entity (optional)</summary>
            <div class="row" style="margin-top:10px">
              <div>
                <label>Entity name</label>
                <input id="entityName" placeholder="Bright Smile Dental — AI Receptionist" />
              </div>
              <div>
                <label>Industry</label>
                <input id="entityIndustry" placeholder="Dental / Local services" />
              </div>
            </div>
            <label>Offer</label>
            <input id="entityOffer" placeholder="AI receptionist that answers + books appointments" />
          </details>

          <label>Context (required)</label>
          <textarea id="context" placeholder="What you’re selling + who you’re calling + goal of the call. Keep it short."></textarea>

          <div style="display:flex;gap:10px;margin-top:10px">
            <button class="btn primary" id="btnRun">Run analysis</button>
            <button class="btn" id="btnClear">Clear</button>
          </div>

          <div class="muted" style="margin-top:10px" id="runStatus"></div>
        </div>

        <div id="reportView" class="card" style="display:none"></div>

        <div id="tab-runs" class="card" style="display:none">
          <h2>Runs</h2>
          <div class="muted">Click a run to open the command center report.</div>
          <div id="runsList"></div>
        </div>

        <div id="tab-entities" class="card" style="display:none">
          <h2>Entities</h2>
          <div class="muted">Group runs under one business/offer.</div>

          <details>
            <summary>Create entity</summary>
            <div style="margin-top:10px">
              <label>Name</label>
              <input id="newEntityName" placeholder="Entity name" />
              <div class="row">
                <div>
                  <label>Offer</label>
                  <input id="newEntityOffer" placeholder="Offer" />
                </div>
                <div>
                  <label>Industry</label>
                  <input id="newEntityIndustry" placeholder="Industry" />
                </div>
              </div>
              <label>Notes</label>
              <textarea id="newEntityNotes" placeholder="Notes (optional)"></textarea>
              <button class="btn primary" id="btnCreateEntity" style="margin-top:10px">Create</button>
              <div class="muted" id="entityCreateMsg" style="margin-top:8px"></div>
            </div>
          </details>

          <div class="hr"></div>
          <div id="entitiesList"></div>
        </div>

        <div id="tab-playbook" class="card" style="display:none">
          <h2>Playbook</h2>
          <div class="muted">Generate an “ultimate script” + patterns across calls for one entity.</div>

          <label>Select entity</label>
          <select id="playbookEntitySelect">
            <option value="">Choose an entity</option>
          </select>

          <div style="display:flex;gap:10px;margin-top:10px">
            <button class="btn primary" id="btnGenPlaybook">Generate / Refresh Playbook</button>
          </div>

          <div class="muted" id="playbookMsg" style="margin-top:10px"></div>
          <div id="playbookOut" style="margin-top:10px"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    let supabase = null;
    let config = null;
    let entities = [];
    let runs = [];
    let currentRun = null;

    const $ = (id) => document.getElementById(id);

    function toast(msg){
      const t = $("toast");
      t.textContent = msg;
      t.style.display = "block";
      setTimeout(()=>t.style.display="none", 1400);
    }

    async function api(path, opts={}){
      const res = await fetch(path, opts);
      const txt = await res.text();
      let data = null;
      try { data = JSON.parse(txt); } catch { data = { raw: txt }; }
      if (!res.ok) throw new Error(data?.error || txt || "Request failed");
      return data;
    }

    function setUserUI(email){
      $("pillUser").textContent = email ? email : "Not signed in";
      $("btnSignOut").style.display = email ? "inline-block" : "none";
    }

    function showAuth(){
      $("authView").style.display = "block";
      $("appView").style.display = "none";
    }

    function showApp(){
      $("authView").style.display = "none";
      $("appView").style.display = "block";
    }

    async function initSupabase(){
      config = await api("/api/config");
      supabase = window.supabase.createClient(config.supabaseUrl, config.supabaseAnonKey);

      const { data: { session } } = await supabase.auth.getSession();
      if (!session?.user) {
        setUserUI(null);
        showAuth();
      } else {
        setUserUI(session.user.email);
        showApp();
        await bootAppData();
      }

      supabase.auth.onAuthStateChange(async (event, session) => {
        if (session?.user) {
          setUserUI(session.user.email);
          showApp();
          await bootAppData();
        } else {
          setUserUI(null);
          showAuth();
        }
      });
    }

    async function bootAppData(){
      await loadEntities();
      await loadRuns();
      fillEntitySelects();
    }

    function fillEntitySelects(){
      const sel = $("entitySelect");
      const sel2 = $("playbookEntitySelect");
      sel.innerHTML = `<option value="">None</option>` + entities.map(e=>`<option value="${e.id}">${escapeHtml(e.name)}</option>`).join("");
      sel2.innerHTML = `<option value="">Choose an entity</option>` + entities.map(e=>`<option value="${e.id}">${escapeHtml(e.name)}</option>`).join("");
    }

    function escapeHtml(s){
      return String(s || "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
    }

    function setTab(name){
      document.querySelectorAll(".tab").forEach(b=>{
        b.classList.toggle("active", b.dataset.tab === name);
      });
      ["upload","runs","entities","playbook"].forEach(t=>{
        const el = $("tab-" + t);
        if (el) el.style.display = (t === name ? "block" : "none");
      });
      // report stays under upload, so hide it when not in upload
      if (name !== "upload") $("reportView").style.display = "none";
    }

    async function loadEntities(){
      const data = await api("/api/entities");
      entities = data.entities || [];
      renderEntities();
    }

    async function loadRuns(){
      const data = await api("/api/runs");
      runs = data.runs || [];
      renderRuns();
    }

    function renderRuns(){
      const wrap = $("runsList");
      if (!runs.length){
        wrap.innerHTML = `<div class="muted" style="margin-top:10px">No runs yet.</div>`;
        return;
      }
      wrap.innerHTML = runs.map(r=>`
        <div class="listItem" style="cursor:pointer" data-run="${r.id}">
          <div class="t">${escapeHtml(r.filename || "Run")}</div>
          <div class="s">${escapeHtml(new Date(r.created_at).toLocaleString())} • ${escapeHtml(r.call_result || "Other")} • Grade ${escapeHtml(r.overall_grade || "")} • Score ${escapeHtml(r.overall_score ?? "")}</div>
        </div>
      `).join("");

      wrap.querySelectorAll("[data-run]").forEach(el=>{
        el.addEventListener("click", async ()=>{
          const id = el.getAttribute("data-run");
          const data = await api(`/api/runs/${id}`);
          currentRun = data.run;
          setTab("upload");
          renderReport(currentRun);
        });
      });
    }

    function renderEntities(){
      const wrap = $("entitiesList");
      if (!entities.length){
        wrap.innerHTML = `<div class="muted">No entities yet.</div>`;
        return;
      }
      wrap.innerHTML = entities.map(e=>`
        <div class="listItem">
          <div class="t">${escapeHtml(e.name)}</div>
          <div class="s">${escapeHtml(e.industry || "")}${e.offer ? " • " + escapeHtml(e.offer) : ""}</div>
        </div>
      `).join("");
    }

    function gradeClass(g){
      return ["A","B","C","D","F"].includes(g) ? g : "C";
    }

    function renderReport(run){
      const a = run.analysis_json || {};
      const badges = Array.isArray(a.signal_badges) ? a.signal_badges : [];

      const top3 = Array.isArray(a.fix_these_first_top3) ? a.fix_these_first_top3 : [];
      const follow = a.followup || {};
      const rep = a.repackaged_sections || {};

      const transcript = run.transcript_text || "";

      $("reportView").style.display = "block";
      $("reportView").innerHTML = `
        <h2>Call Report</h2>

        <div class="card" style="box-shadow:none;margin-top:10px;padding:14px;background:var(--muted)">
          <div class="big">
            <div class="result">
              <div class="muted">Call Result</div>
              <div class="label">${escapeHtml(a.call_result || run.call_result || "Other")}</div>
              <div class="muted">${escapeHtml(a.call_result_reason || run.call_result_reason || "")}</div>
              <div class="kpi">
                ${badges.slice(0,6).map(b=>`<div class="badge">${escapeHtml(b)}</div>`).join("")}
              </div>
            </div>

            <div class="scorebox">
              <div class="muted">Overall</div>
              <div class="grade ${gradeClass(a.overall_grade || run.overall_grade || "C")}">
                Grade ${escapeHtml(a.overall_grade || run.overall_grade || "C")}
              </div>
              <div class="pill mono">Score ${escapeHtml(a.overall_score_0_100 ?? run.overall_score ?? "")}/100</div>
            </div>
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <div class="card" style="box-shadow:none">
            <h2>Follow-Up (2 lines)</h2>
            <div class="muted">Fastest “do this now” action.</div>
            <div class="listItem" style="margin-top:10px">
              <div class="mono" id="followText">${escapeHtml(follow.two_line || "")}</div>
            </div>
            <div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap">
              <button class="btn primary" id="btnCopyFollow">Copy</button>
              <button class="btn" id="btnCopyAlt1" ${follow.alt_versions?.[0] ? "" : "disabled"}>Copy Alt #1</button>
              <button class="btn" id="btnCopyAlt2" ${follow.alt_versions?.[1] ? "" : "disabled"}>Copy Alt #2</button>
            </div>
          </div>

          <div class="card" style="box-shadow:none">
            <h2>Fix These First (Top 3)</h2>
            <div class="muted">These are the highest-leverage corrections for the next call.</div>
            ${top3.length ? top3.slice(0,3).map(x=>`
              <div class="listItem">
                <div class="t">${escapeHtml(x.issue || "Issue")}</div>
                <div class="s"><b>Why:</b> ${escapeHtml(x.why_it_hurt || "")}</div>
                <div class="s"><b>Do instead:</b> ${escapeHtml(x.do_this_instead || "")}</div>
                ${x.example_line ? `<div class="s"><b>Example:</b> ${escapeHtml(x.example_line)}</div>` : ""}
                ${x.evidence_quote ? `<div class="s"><b>Evidence:</b> “${escapeHtml(x.evidence_quote)}”</div>` : ""}
              </div>
            `).join("") : `<div class="muted" style="margin-top:10px">No top issues returned.</div>`}
          </div>
        </div>

        <div class="hr"></div>

        <details>
          <summary>View Transcript</summary>
          <pre>${escapeHtml(transcript || "No transcript saved.")}</pre>
        </details>

        <details style="margin-top:10px">
          <summary>More report details (keeps everything, repackaged)</summary>

          <div class="listItem">
            <div class="t">Call summary</div>
            <div class="s">${escapeHtml(rep.section_1_call_summary || "")}</div>
          </div>

          <div class="listItem">
            <div class="t">Objections</div>
            <div class="s">
              ${(rep.section_2_objections || []).map(o=>`• ${escapeHtml(o.objection)} → ${escapeHtml(o.best_response)} (avoid: ${escapeHtml(o.avoid)})`).join("<br>") || "None"}
            </div>
          </div>

          <div class="listItem">
            <div class="t">Offer clarity</div>
            <div class="s"><b>Clear:</b> ${escapeHtml(rep.section_3_offer_clarity?.what_was_clear || "")}</div>
            <div class="s"><b>Missing:</b> ${escapeHtml(rep.section_3_offer_clarity?.what_was_missing || "")}</div>
          </div>

          <div class="listItem">
            <div class="t">Script upgrade</div>
            <div class="s"><b>Opener:</b> ${escapeHtml(rep.section_4_script_upgrade?.opener || "")}</div>
            <div class="s"><b>Discovery:</b><br>${(rep.section_4_script_upgrade?.discovery_questions || []).map(q=>"• "+escapeHtml(q)).join("<br>")}</div>
            <div class="s"><b>Close:</b> ${escapeHtml(rep.section_4_script_upgrade?.close || "")}</div>
          </div>

          <div class="listItem">
            <div class="t">Moments to review</div>
            <div class="s">
              ${(rep.section_5_moments_to_review || []).map(m=>`• ${escapeHtml(m.moment)} — ${escapeHtml(m.why)}`).join("<br>") || "None"}
            </div>
          </div>

          <div class="listItem">
            <div class="t">Next call micro-plan</div>
            <div class="s">${(rep.section_6_next_call_micro_plan || []).map(s=>"• "+escapeHtml(s)).join("<br>") || "None"}</div>
          </div>
        </details>
      `;

      $("btnCopyFollow").onclick = async ()=> {
        await navigator.clipboard.writeText(follow.two_line || "");
        toast("Copied follow-up");
      };
      $("btnCopyAlt1").onclick = async ()=> {
        await navigator.clipboard.writeText(follow.alt_versions?.[0] || "");
        toast("Copied alt #1");
      };
      $("btnCopyAlt2").onclick = async ()=> {
        await navigator.clipboard.writeText(follow.alt_versions?.[1] || "");
        toast("Copied alt #2");
      };
    }

    $("btnSendLink").addEventListener("click", async ()=>{
      const email = $("authEmail").value.trim();
      $("authMsg").textContent = "";
      if (!email) return ($("authMsg").textContent = "Enter an email.");
      try{
        const { error } = await supabase.auth.signInWithOtp({
          email,
          options: { emailRedirectTo: window.location.origin }
        });
        if (error) throw error;
        $("authMsg").textContent = "Magic link sent. Open your email and click the link.";
      }catch(e){
        $("authMsg").textContent = e.message || String(e);
      }
    });

    $("btnRefreshSession").addEventListener("click", async ()=>{
      const { data: { session } } = await supabase.auth.getSession();
      if (session?.user){
        setUserUI(session.user.email);
        showApp();
        await bootAppData();
      } else {
        $("authMsg").textContent = "No active session detected yet.";
      }
    });

    $("btnSignOut").addEventListener("click", async ()=>{
      await supabase.auth.signOut();
      toast("Signed out");
    });

    document.querySelectorAll(".tab").forEach(btn=>{
      btn.addEventListener("click", ()=>setTab(btn.dataset.tab));
    });

    $("btnClear").addEventListener("click", ()=>{
      $("file").value = "";
      $("scenario").value = "";
      $("context").value = "";
      $("entitySelect").value = "";
      $("entityName").value = "";
      $("entityOffer").value = "";
      $("entityIndustry").value = "";
      $("runStatus").textContent = "";
      $("reportView").style.display = "none";
    });

    $("btnCreateEntity").addEventListener("click", async ()=>{
      $("entityCreateMsg").textContent = "";
      try{
        const payload = {
          name: $("newEntityName").value.trim(),
          offer: $("newEntityOffer").value.trim(),
          industry: $("newEntityIndustry").value.trim(),
          notes: $("newEntityNotes").value.trim(),
        };
        const data = await api("/api/entities", {
          method:"POST",
          headers:{ "content-type":"application/json" },
          body: JSON.stringify(payload)
        });
        $("entityCreateMsg").textContent = "Created.";
        await loadEntities();
        fillEntitySelects();
      }catch(e){
        $("entityCreateMsg").textContent = e.message || String(e);
      }
    });

    $("btnGenPlaybook").addEventListener("click", async ()=>{
      const id = $("playbookEntitySelect").value;
      $("playbookMsg").textContent = "";
      $("playbookOut").innerHTML = "";
      if (!id) return ($("playbookMsg").textContent = "Select an entity first.");
      try{
        $("playbookMsg").textContent = "Generating...";
        const data = await api(`/api/entities/${id}/playbook`, { method:"POST" });
        const pb = data.playbook?.playbook_json || data.playbook?.playbook_json || data.playbook_json || data.playbook;
        $("playbookMsg").textContent = "Done.";
        $("playbookOut").innerHTML = `<pre>${escapeHtml(JSON.stringify(data.playbook?.playbook_json || data.playbook?.playbook_json || data.playbook_json || data.playbook?.playbook_json || data.playbook?.playbook_json || data.playbook?.playbook_json || data.playbook?.playbook_json || data.playbook?.playbook_json || (data.playbook?.playbook_json ?? data.playbook?.playbook_json) || data.playbook?.playbook_json || data.playbook?.playbook_json || data.playbook?.playbook_json || data.playbook?.playbook_json || data.playbook?.playbook_json || data.playbook?.playbook_json || data.playbook?.playbook_json || (data.playbook?.playbook_json ?? {}), null, 2))}</pre>`;
      }catch(e){
        $("playbookMsg").textContent = e.message || String(e);
      }
    });

    $("btnRun").addEventListener("click", async ()=>{
      $("runStatus").textContent = "";
      try{
        const f = $("file").files?.[0];
        if (!f) throw new Error("Choose a file first.");
        const ctx = $("context").value.trim();
        if (!ctx) throw new Error("Context is required.");

        $("btnRun").disabled = true;
        $("runStatus").textContent = "Uploading + transcribing + analyzing...";

        const fd = new FormData();
        fd.append("file", f);
        fd.append("context", ctx);
        fd.append("scenario", $("scenario").value.trim());

        const entityId = $("entitySelect").value;
        if (entityId) fd.append("entityId", entityId);

        const entityName = $("entityName").value.trim();
        if (entityName) {
          fd.append("entityName", entityName);
          fd.append("entityOffer", $("entityOffer").value.trim());
          fd.append("entityIndustry", $("entityIndustry").value.trim());
        }

        const data = await api("/api/run", { method:"POST", body: fd });
        currentRun = data.run;

        $("runStatus").textContent = "Done ✅";
        renderReport(currentRun);

        await loadRuns();
        await loadEntities();
        fillEntitySelects();
      }catch(e){
        $("runStatus").textContent = e.message || String(e);
      }finally{
        $("btnRun").disabled = false;
      }
    });

    (async function(){
      try{
        await initSupabase();
        setTab("upload");
      }catch(e){
        alert("Boot error: " + (e.message || String(e)));
      }
    })();
  </script>
</body>
</html>
